<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CLO Article â†’ Structured Data</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f7f8fa; padding:20px; }
    h1 { color:#222; }
    .container { display:flex; gap:20px; }
    .box { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); flex:1; }
    pre { background:#f0f0f0; padding:10px; border-radius:5px; white-space:pre-wrap; }
    table { border-collapse:collapse; width:100%; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; font-size:14px; }
    th { background:#eee; }
    button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-size:14px; }
    .btn { background:#2e7d32; color:white; margin-top:10px; }
  </style>
</head>
<body>

<h1>ðŸ“‘ CLO Article â†’ Structured Data</h1>
<p>Upload an article screenshot. Output shows structured deal info + tranche table.</p>

<input type="file" id="fileInput" accept="image/*"><br><br>
<button class="btn" onclick="runOCR()">Run OCR & Extract</button>

<div class="container" style="margin-top:20px;">
  <div class="box">
    <h3>Structured Deal Info</h3>
    <pre id="dealInfo">Waiting...</pre>
  </div>
  <div class="box">
    <h3>Tranche Table</h3>
    <table id="trancheTable">
      <thead>
        <tr>
          <th>Class</th><th>Size ($M)</th><th>Expected Rating</th><th>Coupon</th><th>Price</th><th>Discount Margin</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
async function runOCR() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) { alert("Please upload an image."); return; }

  const { data: { text } } = await Tesseract.recognize(file, 'eng');

  // Clean OCR text
  const cleanText = text.replace(/\s+/g, ' ').trim();

  // --- Deal Info Extraction ---
  const deal = {
    issuer: (cleanText.match(/(CLO \d+|Elmwood CLO 45 Ltd.*?LLC)/i) || [null])[0],
    deal_size_millions: parseFloat((cleanText.match(/\$([0-9,.]+)M/) || [0,0])[1].replace(/,/g,'')) || null,
    close_date: (cleanText.match(/close on ([A-Za-z]+\.? \d{1,2}, \d{4})/i) || [null,null])[1],
    non_call_end_date: (cleanText.match(/non-?call period ending ([A-Za-z]+\.? \d{1,2}, \d{4})/i) || [null,null])[1],
    reinvestment_end_date: (cleanText.match(/reinvestment period .* (October \d{4})/i) || [null,null])[1],
    final_maturity: (cleanText.match(/final maturity .* (October \d{4})/i) || [null,null])[1]
  };

  document.getElementById("dealInfo").textContent = JSON.stringify(deal, null, 2);

  // --- Tranche Table Extraction ---
  const trancheRows = [];
  const trancheRegex = /(A-1|A-2|B|C|D|E|F|Sub Notes)\s+([\d.]+)\s+([A-Z-]+|NR)\s+([S+\d]+)?\s+(\d+)\s+(\d+)/gi;

  let m;
  while ((m = trancheRegex.exec(cleanText)) !== null) {
    trancheRows.push({
      class: m[1],
      size_m: parseFloat(m[2]),
      rating: m[3],
      coupon: m[4] || "",
      price: m[5],
      dm: m[6]
    });
  }

  // Render table
  const tbody = document.querySelector("#trancheTable tbody");
  tbody.innerHTML = "";
  trancheRows.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${row.class}</td><td>${row.size_m}</td><td>${row.rating}</td>
                    <td>${row.coupon}</td><td>${row.price}</td><td>${row.dm}</td>`;
    tbody.appendChild(tr);
  });
}
</script>

</body>
</html>

