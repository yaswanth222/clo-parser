<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CLO Structured Extractor</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f7f8fa; padding:20px; }
    h1 { color:#222; }
    .box { background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    pre { background:#f0f0f0; padding:10px; border-radius:5px; white-space:pre-wrap; }
    button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-size:14px; background:#2e7d32; color:white; }
  </style>
</head>
<body>

<h1>ðŸ“‘ CLO Article â†’ Structured Fields</h1>
<input type="file" id="fileInput" accept="image/*"><br><br>
<button onclick="runOCR()">Run OCR & Extract</button>

<div class="box" style="margin-top:20px;">
  <h3>Structured CLO Data</h3>
  <pre id="dealInfo">Waiting...</pre>
</div>

<script>
async function runOCR() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) { alert("Please upload an image."); return; }

  const { data: { text } } = await Tesseract.recognize(file, 'eng');
  const cleanText = text.replace(/\s+/g, ' ').trim();

  function normalizeDate(raw, short=false) {
    if (!raw) return null;
    try {
      const d = new Date(raw.replace(/\./g,""));
      if (!isNaN(d)) {
        if (short) {
          // mm/dd/yy
          let mm = String(d.getMonth()+1).padStart(2,'0');
          let dd = String(d.getDate()).padStart(2,'0');
          let yy = String(d.getFullYear()).slice(-2);
          return `${mm}/${dd}/${yy}`;
        }
        return d.toISOString().split("T")[0];
      }
    } catch {}
    return raw;
  }

  // --- Extract with regex ---
  const cloClose = (cleanText.match(/(expected to close|settle).*?([A-Za-z]+\.? \d{1,2}, \d{4})/i) || [null,null,null])[2];
  const pricedDate = (cleanText.match(/priced (on )?([A-Za-z]+\.? \d{1,2}, \d{4})/i) || [null,null,null])[2];
  const maturity = (cleanText.match(/final maturity.*?([A-Za-z]+\.? \d{1,2}, \d{4}|[A-Za-z]+ \d{4})/i) || [null,null,null])[2];
  const reinv = (cleanText.match(/reinvestment.* (January|February|March|April|May|June|July|August|September|October|November|December) ?\d{0,2},? \d{4}/i) || [null,null])[0];
  const noncall = (cleanText.match(/non-?call.* ([A-Za-z]+\.? \d{1,2}, \d{4})/i) || [null,null,null])[2];

  const deal = {
    "CLO Close Date": normalizeDate(cloClose),
    "Priced Date": normalizeDate(pricedDate),
    "Maturity Date": normalizeDate(maturity,true),   // mm/dd/yy format
    "Reinv Period End Date": normalizeDate(reinv),
    "Non-call Period End Date": normalizeDate(noncall)
  };

  document.getElementById("dealInfo").textContent = JSON.stringify(deal, null, 2);
}
</script>

</body>
</html>
